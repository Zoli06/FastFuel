#!/bin/sh

FAILED=0

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ” PRE-COMMIT QUALITY CHECKS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

check() {
  NAME="$1"
  DIR="$2"
  CMD="$3"
  FIX_CMD="$4"

  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "ğŸ“ Checking folder: $DIR"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""

  (
    cd "$DIR" || exit 1
    sh -c "$CMD"
  )

  if [ $? -ne 0 ]; then
    FAILED=1
    echo ""
    echo "âŒ Check FAILED in: $DIR"
    echo ""
    echo "Fix it by running:"
    echo "  cd $DIR"
    echo "  $FIX_CMD"
    echo ""
  else
    echo ""
    echo "âœ… Check passed: $DIR"
    echo ""
  fi
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Backend
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
check "Backend compiler errors and warnings" "server/FastFuel" \
  "dotnet build -warnaserror" \
  "FIX YOUR CODE BRUH, NO COMMAND CAN HELP YOU HERE"

check "Backend code formatting" "server/FastFuel" \
  "dotnet format --verify-no-changes" \
  "dotnet format"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Frontend
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
check "Frontend linter errors and warnings" "client/fast-fuel" \
  "npm run lint" \
  "npm run lint -- --fix"

check "Frontend code formatting" "client/fast-fuel" \
  "npm run prettier:check" \
  "npm run format"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

if [ $FAILED -ne 0 ]; then
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "âŒ COMMIT BLOCKED"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "One or more checks failed."
  echo ""
  echo "Fix the issues using the commands above,"
  echo "then commit again."
  echo ""
  echo "âš ï¸  Bypass (NOT recommended):"
  echo "   git commit --no-verify"
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""

  exit 1
fi

echo ""
echo "âœ… All checks passed"
exit 0