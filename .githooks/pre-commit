#!/bin/sh

FAILED=0
TMP_DIR="$(mktemp -d)"

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ” PRE-COMMIT QUALITY CHECKS (PARALLEL)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

run_check() {
  IDX="$1"
  NAME="$2"
  DIR="$3"
  CMD="$4"
  FIX_CMD="$5"

  OUT="$TMP_DIR/out_$IDX"
  STATUS="$TMP_DIR/status_$IDX"
  NAME_F="$TMP_DIR/name_$IDX"
  DIR_F="$TMP_DIR/dir_$IDX"
  FIX_F="$TMP_DIR/fix_$IDX"

  printf "%s" "$NAME" >"$NAME_F"
  printf "%s" "$DIR" >"$DIR_F"
  printf "%s" "$FIX_CMD" >"$FIX_F"

  (
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ“ Checking folder: $DIR for: $NAME"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""

    cd "$DIR" || exit 1
    sh -c "$CMD"
  ) >"$OUT" 2>&1

  echo $? >"$STATUS"
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Schedule checks
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

i=0

run_check $i "Backend compiler errors and warnings" "server/FastFuel" \
  "dotnet build -warnaserror" \
  "" &
i=$((i+1))

run_check $i "Backend code formatting" "server/FastFuel" \
  "dotnet format --verify-no-changes" \
  "dotnet format" &
i=$((i+1))

run_check $i "Frontend linter errors and warnings" "client/fast-fuel" \
  "npm run lint" \
  "npm run lint -- --fix" &
i=$((i+1))

run_check $i "Frontend code formatting" "client/fast-fuel" \
  "npm run prettier:check" \
  "npm run format" &
i=$((i+1))

run_check $i "Frontend type errors" "client/fast-fuel" \
  "npm run test:ts" \
  "" &
i=$((i+1))

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Wait for all
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
wait

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Print results
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

i=0
while [ -f "$TMP_DIR/status_$i" ]; do
  STATUS="$(cat "$TMP_DIR/status_$i")"
  NAME="$(cat "$TMP_DIR/name_$i")"
  DIR="$(cat "$TMP_DIR/dir_$i")"
  FIX_CMD="$(cat "$TMP_DIR/fix_$i")"

  cat "$TMP_DIR/out_$i"

  if [ "$STATUS" -ne 0 ]; then
    FAILED=1
    echo ""
    echo "âŒ Check FAILED in: $DIR"
    echo ""

    if [ -n "$FIX_CMD" ]; then
      echo "Fix it by running:"
      echo "  cd $DIR"
      echo "  $FIX_CMD"
    else
      echo "â„¹ï¸  No automatic fix command provided."
    fi

    echo ""
  else
    echo ""
    echo "âœ… Check passed: $DIR"
    echo ""
  fi

  i=$((i+1))
done

rm -rf "$TMP_DIR"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Final result
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

if [ $FAILED -ne 0 ]; then
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "âŒ COMMIT BLOCKED"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "One or more checks failed."
  echo ""
  echo "Fix the issues using the commands above,"
  echo "then commit again."
  echo ""
  echo "âš ï¸  Bypass (NOT recommended):"
  echo "   git commit --no-verify"
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  exit 1
fi

echo ""
echo "âœ… All checks passed"
exit 0
